<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Stock Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .positive { color: #22c55e; }
        .negative { color: #ef4444; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 p-4 md:p-8">

    <header class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-blue-400">RIDAWN STOCK EXCHANGE</h1>
        <div class="text-sm text-gray-400" id="lastUpdated">
            Connecting...
        </div>
    </header>

    <!-- Error Box -->
    <div id="errorBox" class="hidden bg-red-800 border border-red-600 text-red-100 px-4 py-3 rounded-lg mb-6">
      <strong class="font-bold">Dashboard Error:</strong>
      <span id="errorMessage" class="block sm:inline"></span>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        
        <!-- NIFTY 50 -->
        <div id="NIFTY 50" class="card rounded-lg shadow-xl p-6">
            <h2 class="text-xl font-bold mb-4">NIFTY 50</h2>
            <div id="price-NIFTY 50" class="text-4xl font-light mb-2">Loading...</div>
            <div id="change-NIFTY 50" class="text-lg font-medium">Loading...</div>
        </div>

        <!-- BANK NIFTY -->
        <div id="NIFTY BANK" class="card rounded-lg shadow-xl p-6">
            <h2 class="text-xl font-bold mb-4">BANK NIFTY</h2>
            <div id="price-NIFTY BANK" class="text-4xl font-light mb-2">Loading...</div>
            <div id="change-NIFTY BANK" class="text-lg font-medium">Loading...</div>
        </div>

        <!-- NIFTY MIDCAP 50 -->
        <div id="NIFTY MIDCAP 50" class="card rounded-lg shadow-xl p-6">
            <h2 class="text-xl font-bold mb-4">NIFTY MIDCAP 50</h2>
            <div id="price-NIFTY MIDCAP 50" class="text-4xl font-light mb-2">Loading...</div>
            <div id="change-NIFTY MIDCAP 50" class="text-lg font-medium">Loading...</div>
        </div>
        
        <!-- SENSEX -->
        <div id="SENSEX" class="card rounded-lg shadow-xl p-6 md:col-span-1">
            <h2 class="text-xl font-bold mb-4">SENSEX</h2>
            <div id="price-SENSEX" class="text-4xl font-light mb-2">Loading...</div>
            <div id="change-SENSEX" class="text-lg font-medium">Loading...</div>
        </div>

    </div>

    <footer class="text-center text-gray-500 mt-8">
        Zerodha Kite (Real-time)
    </footer>

    <script>
        const instruments = {
            "NSE:NIFTY 50": "NIFTY 50",
            "NSE:NIFTY BANK": "BANK NIFTY",
            "NSE:NIFTY MIDCAP 50": "NIFTY MIDCAP 50",
            "BSE:SENSEX": "SENSEX"
        };
        
        const errorBox = document.getElementById('errorBox');
        const errorMessage = document.getElementById('errorMessage');

        async function fetchData() {
            try {
                // This calls "Mode B" of our api/kite-data.js file
                const response = await fetch('/api/kite-data');
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch data');
                }
                
                // Hide error if it was visible
                errorBox.classList.add('hidden');

                // Loop through the data and update the dashboard
                for (const instrumentName in data) {
                    const stock = data[instrumentName];
                    const cardId = instruments[instrumentName]; // e.g., "NIFTY 50"
                    
                    if (cardId) {
                        const priceEl = document.getElementById(`price-${cardId}`);
                        const changeEl = document.getElementById(`change-${cardId}`);
                        
                        const change = stock.change.toFixed(2);
                        const changePercent = stock.change_percent.toFixed(2);
                        const isPositive = change >= 0;

                        priceEl.textContent = stock.last_price.toFixed(2);
                        changeEl.textContent = `${isPositive ? '+' : ''}${change} (${isPositive ? '+' : ''}${changePercent}%)`;
                        
                        // Set color
                        priceEl.classList.toggle('positive', isPositive);
                        priceEl.classList.toggle('negative', !isPositive);
                        changeEl.classList.toggle('positive', isPositive);
                        changeEl.classList.toggle('negative', !isPositive);
                    }
                }

                // Update timestamp
                document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;

            } catch (err) {
                console.error('Dashboard Error:', err);
                errorMessage.textContent = err.message;
                errorBox.classList.remove('hidden');
                
                // Stop trying if we get an error (like a token error)
                clearInterval(updateInterval);
            }
        }

        // Fetch data immediately on load, then every 3 seconds
        fetchData();
        const updateInterval = setInterval(fetchData, 3000);

    </script>
</body>
</html>
